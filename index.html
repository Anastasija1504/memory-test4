<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Переверни послідовність — гра</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#7dd3fc;--accent2:#a78bfa;--glass: rgba(255,255,255,0.04)}
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,'Helvetica Neue',Arial}
    body{margin:0;min-height:100vh;background:linear-gradient(180deg,#071023 0%, #071a2a 60%), radial-gradient(600px 300px at 10% 20%, rgba(122,85,255,0.07), transparent);color:#e6eef8;display:flex;align-items:center;justify-content:center;padding:28px}
    .app{width:980px;max-width:96%;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:18px;padding:22px;box-shadow:0 10px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
    header{display:flex;align-items:center;gap:16px;margin-bottom:14px}
    .logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:700;color:#04263b;box-shadow:0 6px 20px rgba(120,63,255,0.12)}
    h1{font-size:20px;margin:0}
    p.lead{margin:0;color:rgba(230,238,248,0.75)}

    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}

    .card{background:var(--card);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    .controls{display:flex;flex-direction:column;gap:10px}
    label{font-size:13px;color:rgba(230,238,248,0.8)}
    input[type=text]{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-size:15px}
    .btn{appearance:none;border:0;padding:11px 14px;border-radius:10px;font-weight:600;cursor:pointer}
    .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#022235}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.05);color:inherit}

    .stage{height:240px;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px}

    .sequence-box{
      width:320px;
      height:120px;
      border-radius:12px;
      background:var(--glass);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:62px;
      letter-spacing:8px;
      color:rgba(255,255,255,0.95);
      text-align:center;
    }

    .sequence-box.small-text{
      font-size:20px !important;
      letter-spacing:1px !important;
      line-height:1.2;
      padding:10px;
    }

    .digit{width:84px;height:84px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:36px;background:transparent}
    .glow{animation:glow 700ms ease-in-out;box-shadow:0 12px 40px rgba(125,211,252,0.18), inset 0 -8px 20px rgba(167,139,250,0.06)}
    @keyframes glow{0%{transform:scale(0.9);opacity:0.2}50%{transform:scale(1.05);opacity:1}100%{transform:scale(1);opacity:1}}

    .info-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.03);font-weight:600}
    .footer-stats{display:flex;gap:12px;margin-top:12px;align-items:center}
    .small{font-size:13px;color:rgba(230,238,248,0.7)}
    .result{font-size:16px;font-weight:700}
    .history{max-height:220px;overflow:auto;padding-right:8px}
    .round-item{padding:8px;border-radius:8px;margin-bottom:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border:1px solid rgba(255,255,255,0.02);display:flex;justify-content:space-between;align-items:center}
    footer.note{margin-top:12px;font-size:13px;color:rgba(230,238,248,0.6)}
    @media (max-width:880px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="app" role="application">
    <header>
      <div class="logo">RS</div>
      <div>
        <h1>Переверни послідовність</h1>
        <p class="lead">Дивись числа, потім введи їх у зворотному порядку. 5 рівнів — по 3 спроби на рівень.</p>
      </div>
    </header>

    <div class="grid">
      <main class="card">
        <div class="controls">
          <label>Введіть ім'я гравця</label>
          <input id="playerName" type="text" placeholder="Ваше ім'я" />
          <div style="display:flex;gap:10px;margin-top:8px">
            <button id="startBtn" class="btn btn-primary" type="button">Почати гру</button>
          </div>
        </div>

        <div class="stage" style="margin-top:14px">
          <div class="info-row">
            <div class="pill">Рівень: <span id="level">—</span></div>
            <div class="pill">Хід: <span id="round">—</span>/3</div>
            <div class="pill">Довжина послідовності: <span id="len">—</span></div>
          </div>

          <div class="sequence-box small-text" id="display">Натисніть «Почати гру»</div>

          <div style="width:100%;display:flex;gap:8px;align-items:center">
            <input id="answer" type="text" placeholder="Введіть відповідь тут" />
            <!-- обов'язково type="button" -->
            <button id="submitBtn" class="btn btn-primary" type="button">Відправити</button>
          </div>

          <div class="footer-stats">
            <div class="small">Гравець: <span id="player">—</span></div>
            <div class="small">Балів: <span id="score">0</span></div>
            <div class="small">Приклад №: <span id="exampleIndex">—</span></div>
          </div>
        </div>
      </main>

      <aside class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
          <div><strong>Прогрес</strong><div class="small">5 рівнів • 3 приклади / рівень</div></div>
          <div class="small">Час показу: <span id="showTime">700ms</span></div>
        </div>

        <div class="history" id="history"></div>

        <div style="margin-top:12px">
          <div class="result" id="finalResult"></div>
          <div class="note small">Після кожного прикладу ви отримаєте підсумок — правильно/неправильно та правильну відповідь.</div>
        </div>
      </aside>
    </div>

    <footer class="note">Інструкція: дивіться числа по черзі. Вони з'являються і зникають — запам'ятайте порядок і введіть його у зворотному напрямку.</footer>
  </div>

  <script>
    // БIND AFTER DOM READY
    document.addEventListener('DOMContentLoaded', ()=>{

      // settings
      const LEVELS = 5;
      const EXAMPLES_PER_LEVEL = 3;
      const SEQ_LENGTHS = [3,4,5,6,7];
      const SHOW_MS = 700;

      // state
      let state = {player:'', level:0, example:0, score:0, currentSeq:[], awaiting:false, history:[]};

      // elements
      const playerName = document.getElementById('playerName');
      const startBtn = document.getElementById('startBtn');
      const display = document.getElementById('display');
      const levelEl = document.getElementById('level');
      const roundEl = document.getElementById('round');
      const lenEl = document.getElementById('len');
      const answer = document.getElementById('answer');
      const submitBtn = document.getElementById('submitBtn');
      const playerEl = document.getElementById('player');
      const scoreEl = document.getElementById('score');
      const historyEl = document.getElementById('history');
      const exampleIndexEl = document.getElementById('exampleIndex');
      const finalResultEl = document.getElementById('finalResult');
      const showTimeEl = document.getElementById('showTime');

      // guard: if any required el is missing, bail with console message
      if(!startBtn || !submitBtn || !answer || !display){
        console.error('Required element missing:', {startBtn, submitBtn, answer, display});
        return;
      }

      showTimeEl.textContent = SHOW_MS + 'ms';

      // attach handlers
      startBtn.addEventListener('click', startGame);
      submitBtn.addEventListener('click', (e)=> { e.preventDefault(); submitAnswer(); });

      // Enter handler (keydown and keyup to be robust)
      answer.addEventListener('keydown', e => {
        if(e.key === 'Enter'){
          e.preventDefault();
          submitAnswer();
        }
      });

      // Start with reset state
      resetGame();

      /* ---------- game functions ---------- */

      function startGame(){
        state.player = playerName.value.trim() || 'Гравець';
        state.level = 1;
        state.example = 1;
        state.score = 0;
        state.history = [];
        updateUI();
        playerEl.textContent = state.player;
        finalResultEl.textContent = '';
        nextExample();
      }

      function resetGame(){
        state = {player:'', level:0, example:0, score:0, currentSeq:[], awaiting:false, history:[]};
        updateUI();
        display.classList.add('small-text');
        display.textContent = 'Натисніть «Почати гру»';
        playerName.value = '';
        playerEl.textContent = '—';
        historyEl.innerHTML = '';
        finalResultEl.textContent = '';
        scoreEl.textContent = '0';
      }

      function updateUI(){
        levelEl.textContent = state.level>0?state.level:'—';
        roundEl.textContent = state.example>0?state.example:'—';
        lenEl.textContent = state.level>0?SEQ_LENGTHS[state.level-1]:'—';
        exampleIndexEl.textContent = ((state.level-1)*EXAMPLES_PER_LEVEL + state.example) || '—';
        scoreEl.textContent = state.score;
        // Preserve user input if not cleared intentionally:
        if(!state.awaiting) {
          // keep existing answer visible but disable it
        } else {
          answer.value = '';
        }
        answer.disabled = !state.awaiting;
        submitBtn.disabled = !state.awaiting;
      }

      function nextExample(){
        if(state.level > LEVELS){
          finishGame(); return;
        }
        const seqLen = SEQ_LENGTHS[state.level-1];
        const seq = Array.from({length:seqLen}, () => randomDigit(1,9));
        state.currentSeq = seq;
        state.awaiting = false;
        updateUI();
        playSequence(seq).then(()=>{
          state.awaiting = true;
          updateUI();
          answer.focus();
        }).catch(err=>{
          console.error('playSequence error', err);
          // ensure UI still allows answering to recover
          state.awaiting = true;
          updateUI();
        });
      }

      function randomDigit(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

      async function playSequence(seq){
        display.classList.remove('small-text');
        display.innerHTML = '';
        for(let d of seq){
          display.innerHTML = `<div class="digit glow">${d}</div>`;
          await wait(SHOW_MS);
          display.innerHTML = '';
          await wait(220);
        }
        display.classList.add('small-text');
        display.textContent = 'Тепер введіть відповідь';
      }

      function wait(ms){ return new Promise(r=>setTimeout(r,ms)); }

      function submitAnswer(){
        try{
          if(!state.awaiting){
            // give user feedback if they try to submit too early
            // console.log('Not accepting answers right now');
            return;
          }

          const raw = (answer.value || '').replace(/\s+/g,'');
          if(!raw){
            alert('Введіть відповідь (наприклад 123)');
            answer.focus();
            return;
          }

          const expect = state.currentSeq.slice().reverse().join('');
          const correct = raw === expect;

          if(correct) state.score += 10;

          state.history.push({
            level:state.level, example:state.example,
            seq:state.currentSeq.join(','), answer:raw,
            expect, correct
          });

          addHistoryItem(state.history.at(-1));

          if(state.example < EXAMPLES_PER_LEVEL) state.example++;
          else { state.level++; state.example=1; }

          state.awaiting = false;
          updateUI();

          displayFeedback(correct, expect);

          setTimeout(()=>{
            if(state.level > LEVELS) finishGame();
            else nextExample();
          },800);

        }catch(err){
          console.error('submitAnswer error', err);
        }
      }

      function displayFeedback(correct, expect){
        if(correct){
          display.innerHTML =
            `<div style="text-align:center">
               <div style="font-size:38px;font-weight:700;color:#9ef3d1">Правильно!</div>
               <div class="small">Правильна відповідь: ${expect}</div>
             </div>`;
        } else {
          display.innerHTML =
            `<div style="text-align:center">
               <div style="font-size:34px;font-weight:700;color:#ffb4b4">Неправильно</div>
               <div class="small">Правильна відповідь: ${expect}</div>
             </div>`;
        }
      }

      function addHistoryItem(item){
        const el = document.createElement('div');
        el.className = 'round-item';
        el.innerHTML = `
          <div>Рівень ${item.level} • приклад ${item.example}</div>
          <div style="text-align:right">
            <div style="font-weight:700">${item.correct?'✔':'✖'} ${item.answer}</div>
            <div class="small">правильно: ${item.expect}</div>
          </div>`;
        historyEl.prepend(el);
      }

      function finishGame(){
        display.classList.add('small-text');
        display.innerHTML = `
          <div style="text-align:center">
            <div style="font-size:28px;font-weight:800">Гру завершено</div>
            <div class="small">Балів: ${state.score}</div>
          </div>`;
        finalResultEl.textContent = `${state.player}, ваш рахунок: ${state.score} балів`;
        state.level = LEVELS+1;
        state.awaiting = false;
        updateUI();
      }

    }); // DOMContentLoaded
  </script>
</body>
</html>
