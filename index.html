<script>
  // БIND AFTER DOM READY
  document.addEventListener('DOMContentLoaded', ()=>{

    // settings
    const LEVELS = 5;
    const EXAMPLES_PER_LEVEL = 3;
    const SEQ_LENGTHS = [3,4,5,6,7];
    const SHOW_MS = 700;

    // state
    let state = {player:'', level:0, example:0, score:0, currentSeq:[], awaiting:false, history:[]};

    // elements
    const playerName = document.getElementById('playerName');
    const startBtn = document.getElementById('startBtn');
    const display = document.getElementById('display');
    const levelEl = document.getElementById('level');
    const roundEl = document.getElementById('round');
    const lenEl = document.getElementById('len');
    const answer = document.getElementById('answer');
    const submitBtn = document.getElementById('submitBtn');
    const playerEl = document.getElementById('player');
    const scoreEl = document.getElementById('score');
    const historyEl = document.getElementById('history');
    const exampleIndexEl = document.getElementById('exampleIndex');
    const finalResultEl = document.getElementById('finalResult');
    const showTimeEl = document.getElementById('showTime');

    // guard: if any required el is missing, bail with console message
    if(!startBtn || !submitBtn || !answer || !display){
      console.error('Required element missing:', {startBtn, submitBtn, answer, display});
      return;
    }

    showTimeEl.textContent = SHOW_MS + 'ms';

    // attach handlers
    startBtn.addEventListener('click', startGame);
    // don't prevent default here; call submitAnswer directly
    submitBtn.addEventListener('click', () => submitAnswer());

    // Enter handler - use keyup for reliability
    answer.addEventListener('keyup', e => {
      if(e.key === 'Enter'){
        submitAnswer();
      }
    });

    // Start with reset state
    resetGame();

    /* ---------- game functions ---------- */

    function startGame(){
      state.player = playerName.value.trim() || 'Гравець';
      state.level = 1;
      state.example = 1;
      state.score = 0;
      state.history = [];
      updateUI();
      playerEl.textContent = state.player;
      finalResultEl.textContent = '';
      nextExample();
    }

    function resetGame(){
      state = {player:'', level:0, example:0, score:0, currentSeq:[], awaiting:false, history:[]};
      updateUI();
      display.classList.add('small-text');
      display.textContent = 'Натисніть «Почати гру»';
      playerName.value = '';
      playerEl.textContent = '—';
      historyEl.innerHTML = '';
      finalResultEl.textContent = '';
      scoreEl.textContent = '0';
      // make sure controls are enabled for starting
      answer.disabled = true;
      // keep submit button enabled (we'll guard inside submitAnswer)
      submitBtn.disabled = false;
    }

    function updateUI(){
      levelEl.textContent = state.level>0?state.level:'—';
      roundEl.textContent = state.example>0?state.example:'—';
      lenEl.textContent = state.level>0?SEQ_LENGTHS[state.level-1]:'—';
      exampleIndexEl.textContent = ((state.level-1)*EXAMPLES_PER_LEVEL + state.example) || '—';
      scoreEl.textContent = state.score;
      // enable/disable input for UX, but leave button enabled
      answer.disabled = !state.awaiting;
      if(state.awaiting){
        // prepare input for answer
        answer.value = '';
        answer.focus();
      }
    }

    function nextExample(){
      if(state.level > LEVELS){
        finishGame(); return;
      }
      const seqLen = SEQ_LENGTHS[state.level-1];
      const seq = Array.from({length:seqLen}, () => randomDigit(1,9));
      state.currentSeq = seq;
      state.awaiting = false;
      updateUI();
      playSequence(seq).then(()=>{
        state.awaiting = true;
        updateUI();
      }).catch(err=>{
        console.error('playSequence error', err);
        // allow answering to recover
        state.awaiting = true;
        updateUI();
      });
    }

    function randomDigit(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

    async function playSequence(seq){
      display.classList.remove('small-text');
      display.innerHTML = '';
      for(let d of seq){
        display.innerHTML = `<div class="digit glow">${d}</div>`;
        await wait(SHOW_MS);
        display.innerHTML = '';
        await wait(220);
      }
      display.classList.add('small-text');
      display.textContent = 'Тепер введіть відповідь';
    }

    function wait(ms){ return new Promise(r=>setTimeout(r,ms)); }

    function submitAnswer(){
      try{
        // single gate: only accept when awaiting
        if(!state.awaiting){
          // краще дати користувачеві помітний сигнал
          // коли відповідь не приймається
          display.classList.add('small-text');
          display.textContent = 'Спочатку перегляньте послідовність';
          return;
        }

        const raw = (answer.value || '').replace(/\s+/g,'');
        if(!raw){
          alert('Введіть відповідь (наприклад 123)');
          answer.focus();
          return;
        }

        const expect = state.currentSeq.slice().reverse().join('');
        const correct = raw === expect;

        if(correct) state.score += 10;

        state.history.push({
          level:state.level, example:state.example,
          seq:state.currentSeq.join(','), answer:raw,
          expect, correct
        });

        addHistoryItem(state.history.at(-1));

        if(state.example < EXAMPLES_PER_LEVEL) state.example++;
        else { state.level++; state.example=1; }

        state.awaiting = false;
        updateUI();

        displayFeedback(correct, expect);

        setTimeout(()=>{
          if(state.level > LEVELS) finishGame();
          else nextExample();
        },800);

      }catch(err){
        console.error('submitAnswer error', err);
      }
    }

    function displayFeedback(correct, expect){
      if(correct){
        display.innerHTML =
          `<div style="text-align:center">
             <div style="font-size:38px;font-weight:700;color:#9ef3d1">Правильно!</div>
             <div class="small">Правильна відповідь: ${expect}</div>
           </div>`;
      } else {
        display.innerHTML =
          `<div style="text-align:center">
             <div style="font-size:34px;font-weight:700;color:#ffb4b4">Неправильно</div>
             <div class="small">Правильна відповідь: ${expect}</div>
           </div>`;
      }
    }

    function addHistoryItem(item){
      const el = document.createElement('div');
      el.className = 'round-item';
      el.innerHTML = `
        <div>Рівень ${item.level} • приклад ${item.example}</div>
        <div style="text-align:right">
          <div style="font-weight:700">${item.correct?'✔':'✖'} ${item.answer}</div>
          <div class="small">правильно: ${item.expect}</div>
        </div>`;
      historyEl.prepend(el);
    }

    function finishGame(){
      display.classList.add('small-text');
      display.innerHTML = `
        <div style="text-align:center">
          <div style="font-size:28px;font-weight:800">Гру завершено</div>
          <div class="small">Балів: ${state.score}</div>
        </div>`;
      finalResultEl.textContent = `${state.player}, ваш рахунок: ${state.score} балів`;
      state.level = LEVELS+1;
      state.awaiting = false;
      updateUI();
    }

  }); // DOMContentLoaded
</script>
